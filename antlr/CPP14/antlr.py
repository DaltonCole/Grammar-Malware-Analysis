
import io
import sys
import os

from antlr4 import FileStream, CommonTokenStream, ParseTreeWalker
from antlr4.error.ErrorListener import ErrorListener

from CPP14Lexer import CPP14Lexer
from CPP14Parser import CPP14Parser
from CPP14Listener import CPP14Listener

class CPP14ErrorListener(ErrorListener):
    def __init__(self):
        f = open(os.devnull, 'w')
        #sys.stderr = f
        self.error_count = 0

    def syntaxError(self, recognizer, offendingSymbol, line, column, msg, e):
        self.error_count += 1


class CPP14ParserHandler:
    def setup(self, path):
        '''Set up parser
        Args:
            path (string): path to file

        Returns:
            parser
        '''
        input = FileStream(path)
        lexer = CPP14Lexer(input)
        stream = CommonTokenStream(lexer)

        parser = CPP14Parser(stream)

        self.errorListener = CPP14ErrorListener()
        parser.addErrorListener(self.errorListener)

        parser.removeParseListeners()

        self.print_tokens(stream)

        return parser

    def run_sample(self, path):
        '''Runs the sample through the parser
        Args:
            path (string): path to file

        Returns:
            Dictionary of features with occurrence count if parser completed successfully
            None otherwise
        '''
        parser = self.setup(path)
        tree = parser.translationunit()
        listener = CPP14Listener()
        walker = ParseTreeWalker()
        walker.walk(listener, tree)

        if self.errorListener.error_count != 0:
            return None

        return listener.rule_uses

    def print_tokens(self, stream):
        # print out the token parsing
        stream.fill()
        print('TOKENS')
        for token in stream.tokens:
            if token.text != '<EOF>':
                type_name = CPP14Parser.symbolicNames[token.type]
                tabs = 5 - len(type_name) // 4
                sep = '\t' * tabs
                print('    %s%s%s' % (type_name, sep,
                                      token.text.replace(' ', u'\u23B5').replace('\n', u'\u2936')))



def main(argv):
    parse = CPP14ParserHandler()
    parse.run_sample(argv[1])

if __name__ == '__main__':
    main(sys.argv)